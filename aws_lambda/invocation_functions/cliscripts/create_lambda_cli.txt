#~/bin/ksh

## Creates a schedule
aws events put-rule --name Invoke_SSH_Event_15_mins --schedule-expression "rate(15 minutes)"

## Creates a lambda function
aws lambda create-function \
--function-name ssh_trigger_function \
--runtime python3.6 \
--role arn:aws:iam::<acctid>:role/service-role/ssh_trigger_role \
--handler ssh_trigger_function.trigger_handler \
--vpc-config SubnetIds="subnet-09d972c7c439b8249","subnet-05cc3ac968afef400",SecurityGroupIds="sg-0f382b857eb3de169" \
--zip-file fileb:///home/prashant/python_code/src/aws_lambda/invocation_functions/ssh_trigger_function.zip

## Associating the schedule to the function and allowing only the schedule to execute the function
aws lambda add-permission \
--function-name ssh_trigger_function \
--statement-id Invoke_SSH_Event_15_mins \
--action lambda:InvokeFunction \
--principal events.amazonaws.com \
--source-arn 'arn:aws:events:ap-south-1:acctid:rule/Invoke_SSH_Event_15_mins'

## Adding lambda as a target to the schedule rule
aws events put-targets --rule Invoke_SSH_Event_15_mins \
--targets "Id"="1","Arn"="arn:aws:lambda:ap-south-1:acctid:function:ssh_trigger_function"



### Creating worker lambda function

aws lambda create-function \
--function-name ssh_worker_function \
--runtime python3.6 \
--role arn:aws:iam::973265861767:role/worker_role \
--handler ssh_worker_function.worker_handler \
--vpc-config SubnetIds="subnet-09d972c7c439b8249","subnet-05cc3ac968afef400",SecurityGroupIds="sg-0f382b857eb3de169" \
--zip-file fileb:///home/prashant/python_code/src/aws_lambda/invocation_functions/ssh_worker_function.zip

aws lambda update-function-configuration \
--function-name ssh_trigger_function \
--handler ssh_trigger_function.trigger_handler


aws lambda update-function-code \
--function-name ssh_trigger_function \
--zip-file fileb:///home/prashant/python_code/src/aws_lambda/invocation_functions/ssh_trigger_function.zip

aws lambda update-function-configuration \
--function-name ssh_worker_function \
--handler ssh_worker_function.worker_handler


## zip file creation
zip -g <zipfile name> <source file>

## Adding folders in a recurrsive mode.
zip -r9 <zipfile name> .
